# 第8章 寄存器

学习Vim中的寄存器就像第一次学习线性代数一样，除非你学习了他们，否则你会觉得自己根本不需要它们。

你可能已经在复制或删除文本并用`p`或`P`粘贴它们到别处的时候使用过Vim的寄存器了。但是，你知道Vim总共有10种不同类型的寄存器吗？如果正确地使用Vim寄存器，将帮助您从重复的输入中解放出来。

在这一章节中，我会介绍Vim的所有寄存器类型，以及如何有效地使用它们。

## 寄存器的10种类型

下面是Vim所拥有的10种寄存器类型：

1. 匿名寄存器（`""`）.
2. 编号寄存器(`"0-9`).
3. 小删除寄存器 (`"-`).
4. 命名寄存器 (`"a-z`).
5. 只读寄存器 (`":`, `".`, and `"%`).
6. Buffer交替文件寄存器 (`"#`).
7. 表达式寄存器 (`"=`).
8. 选取和拖放寄存器(`"*` and `"+`).
9. 黑洞寄存器 (`"_`).
10. 搜索模式寄存器 (`"/`).


## 寄存器命令

要使用寄存器，您必须先使用命令将内容存储到寄存器，以下是一些存值到寄存器中的操作：

```
y    复制
c    删除文本并进入输入模式
d    删除文本
```

其实还有更多的寄存器写入操作（比如`s`或`x`），但是上面列出的是最常用的一些。根据经验看来，如果一个操作删除了文本，那么很有可能这个操作将移除的文本存入寄存器中了。

想要从寄存器中取出（粘贴）文本，你可以用以下的命令：

```
p    在光标位置之后粘贴文本
P    在光标位置之前粘贴文本
```

`p`和`P`都可以接受计数和一个寄存器标志作为参数。比如，想要把最近复制的文本粘贴10次的话可以用`10p`。想粘贴寄存器"a"中的文本，可以用`"ap`。想将寄存器“a”中的文本粘贴10次的话，可以使用`10"ap`。注意，从技术层面讲，命令`p`实际上表示的是"put"(放置)，而不是"paste"(粘贴)，使用粘贴只是因为它更符合传统习惯。

从某个特定寄存器中读取文本的通用语法是`"x`，其中`x`是这个寄存器的标志。

## 在输入模式中使用寄存器

在这一章节中你学到的东西在输入模式中也同样适用。想要获取寄存器"a"中的文本，通常可以使用`"ap`来进行。不过当你在输入模式下时，你需要运行`Ctrl-r a`。在输入模式下使用寄存器的语法是：

```
Ctrl-r x
```

其中`x`是寄存器标志。既然你现在已经知道如何存储和访问寄存器了，让我们学点更深入的吧。


##  匿名寄存器(`""`)

想从匿名寄存器中获取文本，可以使用`""p`。 匿名寄存器默认存储着你最近一次复制，修改或删除的文本。如果再进行另一次复制，修改或删除，Vim会自动替换匿名寄存器中的文本。匿名寄存器和电脑上粘贴板的功能很接近。

默认情况下，`p`(或者`P`)是和匿名寄存器相关联的（从现在起我将使用`p`而不是`""p`来指代匿名寄存器）。

## 编号寄存器(`"0-9`)

编号寄存器会自动以升序来进行填充。一共有两种不同的编号寄存器：复制寄存器(`0`)和其他编号寄存器(`1-9`)。让我们先来讨论复制寄存器。

### 复制寄存器 (`"0`)

如果你使用`yy`来复制一整行文本，事实上Vim会将文本存放两个寄存器中：

1. 匿名寄存器 (`p`).
2. 复制寄存器 (`"0p`).

在你又复制其他不同的文本后，Vim会自动替换匿名寄存器和复制寄存器(`0`)中的内容。其他的任何操作都不会被存放在`0`号寄存器中。这可以为你提供方便，因为除非你再进行另一次复制，否则你已经复制的内容会一直在寄存器中，无论你进行多少次修改和删除。

比如，如果你：
1. 复制一整行 (`yy`)
2. 删除一整行(`dd`)
3. 再删除另一行 (`dd`)

复制寄存器中的文本仍然是第一步中复制的文本。

如果你:
1. 复制一整行 (`yy`)
2. 删除一整行 (`dd`)
3. 复制另一行 (`yy`)

复制寄存器中的内容则是第三步中复制的内容。

还有一个小技巧，在输入模式下，你可以使用`Ctrl-r 0`快速地粘贴你刚才复制的内容。

### 编号寄存器 (`"1-9`)

当你修改或者删除至少一整行的文本时，这部分文本会按时间顺序被存储在1-9号编号寄存器中。（编号越小时间距离越近）

比如，你有以下这些文本：

```
line three
line two
line one
```

当你的光标在文本“line three”上时,使用`dd`来一行一行地删除这些文本。在所有文本都已经删除后，1号寄存器中的内容应该是"line one"（时间上最近的文本）， 2号寄存器则包含"line two"(时间上第二近的文本)，3号寄存器中则包含"line three"（最早删除的文本）。普通模式下可以使用`"1p`来获取1号寄存器中的内容。

编号寄存器的编号在使用点命令时会自动增加。比如，如果你的1号编号寄存器（`"1`）中的内容为"line one"， 2号寄存器（`"2`）为"line two", 三号寄存器（`"3`）"line three",你可以使用以下的技巧来连续地粘贴他们：
- 使用`"1p`来粘贴1号寄存器中的内容。
- 使用`.` (点命令)来粘贴2号寄存器（`"2`）中的内容。
- 使用`.` (点命令)来粘贴3号寄存器（`"3`）中的内容。

在连续地使用点命令时，Vim会自动的增加编号寄存器的编号。这个技巧对于所有的编号寄存器都适用。如果你从5号寄存器开始(`"5P`), 点命令`.`会执行`"6P`,再次使用`.`则会执行`"7P`,等等。

小型的删除比如单词删除（`dw`)或者单词修改(`cw`)不会被存储在编号寄存器中，它们被存储在小删除寄存器(`"-`)中，我将在接下来的一小节讨论小删除寄存器。

## 小删除寄存器(`"-`)

不足一行的修改或者删除都不会被存储在0-9号编号寄存器中，而是会被存储在小删除寄存器 (`"-`)中。

比如:
1. 删除一个单词 (`diw`)
2. 删除一行文本 (`dd`)
3. 删除一行文本 (`dd`)

`"-p` 会给你第一步中删除的单词。

另一个例子:
1. 删除一个单词(`diw`)
2. 删除一行文本 (`dd`)
3. 删除一个单词 (`diw`)

`"-p` 会给出第三步中删除的单词。类似地, `"1p` 会给出第二步中删除的一整行文本。不幸的是我们没有办法获取第一步中删除的单词，因为小删除寄存器只能存储一个文本。然而，如果你想保存第一步中删除的文本，你可以使用命名寄存器来完成。

## 命名寄存器 (`"a-z`)

命名寄存器是Vim中用法最丰富的寄存器。a-z命名寄存器可以存储复制的，修改的和被删除的文本。不像之前介绍的3种寄存器一样，它们会自动将文本存储到寄存器中，你需要显式地告诉Vim你要使用命名寄存器，你拥有完整的控制权。

为了复制一个单词到寄存器"a"中，你可以使用命令`"ayiw`。
- `"a`告诉Vim下一个动作（删除/修改/复制）会被存储在寄存器"a"中
- `yiw`复制这个单词

为了从寄存器"a"中获取文本，可以使用命令`"ap`。你可以使用以26个字母命名的寄存器来存储26个不同的文本。

有时你可能会想要往已有内容的命名寄存器中继续添加内容，这种情况下，你可以追加文本而不是全部重来。你可以使用大写版本的命名寄存器来进行文本的追加。比如，假设你的"a"寄存器中已经存有文本"Hello"，如果你想继续添加"world"到寄存器"a"中，你可以先找到文本"world"然后使用`"Aiw`来进行复制,即可完成追加。

## 只读寄存器(`":`, `".`, `"%`)

Vim有三个只读寄存器：`.`,`:`和`%`，它们的用法非常简单：

```
.    存储上一个输入的文本
:    存储上一次执行的命令
%    存储当前文件的文件名
```

如果你写入"Hello Vim",之后再运行`".p`就会打印出文本"Hello Vim"。如果你想要获得当前文件的文件名，可以运行命令`"%p`。如果你运行命令`:s/foo/bar/g`，再运行`":p`的话则会打印出文本"s/foo/bar/g"。

## Buffer交替文件寄存器 (`"#`)

在Vim中，`#`通常代表交替文件。交替文件指的是你上一个打开的文件，想要插入交替文件的名字的话，可以使用命令`"#p`。

## 表达式寄存器 (`"=`)

Vim有一个表达式寄存器，`"=`,用于计算表达式的结果。

你可以使用以下命令计算数学表达式`1+1`的值：

```
"=1+1<Enter>p
```

在这里，你在告诉Vim你正在使用表达式寄存器`"=`，你的表达式是（`1+1`），你还需要输入`p`来得到结果。正如之前所提到的，你也可以在输入模式中访问寄存器。想要在输入模式中计算数学表达式的值，你可以使用：

```
Ctrl-r =1+1
```

你可以使用`@`来从任何寄存器中获取表达式并用表达式寄存器计算其值。如果你希望从寄存器"a"中获取文本：

```
"=@a
```

之后输入`<enter>`，再输入`p`。类似地，想在输入模式中得到寄存器"a"中的值可以使用：

```
Ctrl-r =@a
```

表达式是Vim中非常宏大的一个话题，所以我只会在这里介绍一些基础知识，我将会在之后的VimScript章节中进一步讲解更多关于表达式的细节。

##  选取和拖放寄存器 (`"*`, `"+`)

你难道不觉得有些时候你需要从某些外部的程序中复制一些文本并粘贴到Vim中吗，或者反过来操作？有了Vim的选取和拖放寄存器你就能办到。Vim有两个选取寄存器：`quotestar` (`"*`) 和 `quoteplus` (`"+`)。你可以用它们来访问从外部程序中复制的文本。

如果你在运行一个外部程序（比如Chrome浏览器），然后你使用`Ctrl-c`(或者`Cmd-c`,取决于你的操作系统)复制了一部分文本，通常你是没有办法在Vim里使用`p`来粘贴这部分文本的。但是，Vim的两个寄存器`"+`和`"*`都是和你系统的粘贴板相连接的，所以你可以使用`"+p`和`"*p`来粘贴这些文本。反过来，如果你使用`"+yiw`或者`"*yiw`在Vim中复制了一些文本，你可以使用`Ctrl-v`（或者`Cmd-v`）。值得注意的是这个方法只在你的Vim开启了`+clipboard`选项时才有用，可以在命令行中运行`vim --version`查看这一选项。如果你看见`-clipboard`的话，则需要安装一下支持Vim粘贴板的配置。

你也许会想如果`"*`和`"+`能办到的事完全相同，那为什么Vim需要两个不同的寄存器呢？一些机器使用的是X11窗口系统，这一系统有3个类型的选项：首选，次选和粘贴板。如果你的机器使用的是X11的话,Vim使用的是`quotestar` (`"*`)寄存器作为X11的首选选项，并使用 `quoteplus` (`"+`)作为粘贴板选项。这只在你的Vim配置里开启了`xterm_clipboard` 选项时才有效（`vim --version`中的`+xterm_clipboard`）。如果你的的Vim配置中没有 `xterm_clipboard`也不是什么大问题。这只是意味着`quotestar` 和`quoteplus`两个寄存器是可以互相替代的。

我发觉使用`=*p`或者`=+p`的话比较麻烦，为了使Vim仅使用`p`就能粘贴从外部程序复制的文本，你可以在你的`vimrc`配置文件中加入下面一行：

```
set clipboard=unnamed
```

现在当我从外部程序中复制文本时，我可以使用匿名寄存器`p`来进行粘贴。我也可以在Vim中复制文本后在外部程序中使用`Ctrl-v`来粘贴。如果你的Vim开启了 `+xterm_clipboard`设置，你或许会想同时也使用`unnamed`和`unnamedplus`的粘贴板选项。

## 黑洞寄存器 (`"_`)

你每次删除或修改文本的时候，这部分文本都会自动保存在Vim的寄存器中。有些时候你并不希望把什么东西都往寄存器里存，这该怎么办到呢？

你可以使用黑洞寄存器（`"_`）。想要删除一行并且不将其存储在任何寄存器中时，可以使用`"_dd`命令.

它是和 `/dev/null` 类似的寄存器。

##  搜索模式寄存器 (`"/`)

为了粘贴你的上一个搜索询问（`/` 或 `?`），你可以使用搜索模式寄存器(`"/`)。使用命令 `"/p`就能粘贴上一个搜索的条目。

## 查看所有的寄存器

你可以使用`:register`命令来查看你的所有寄存器。如果你只想查看"a","1"和"-"寄存器的内容的话则可以使用命令`:register a 1 -`。

有一个Vim的插件叫做 [vim-peekaboo](https://github.com/junegunn/vim-peekaboo) ,可以让你查看到寄存器的内容，在普通模式下输入`"`或`@` 即可，或者在输入模式中输入`Ctrl-r`。我发现这个插件相当的有用，因为大多数时候我是记不住我的寄存器中的内容的。值得一试！

## 执行寄存器

命名寄存器不只可以用来存放文本，你还可以借助`@`来执行宏命令。我会在下一章节中介绍宏命令。

注意，因为宏命令时存储在Vim寄存器中的，使用宏时可能会覆盖存储的内容。如果你将文本"Hello Vim"存放在寄存器"a"中，并且之后你在同一个寄存器里记录了一个宏命令 (`qa{macro-commands}q`),那么这个宏命令将会覆盖之前存储的文本"Hello Vim"（你可以使用`@a`来执行寄存器中存储的宏命令）。

## 清除寄存器

从技术上来说，我们没有必要来清除任何寄存器，因为你下一个使用来存储文本的寄存器会自动覆盖该寄存器中之前的内容。然而，你可以通过记录一个空的宏命令来快速地清除任何命名寄存器。比如，如果你运行`qaq`，Vim就会在寄存器"a"中记录一个空的宏命令。

还有一种方法就是运行命令`:call setreg('a','hello register a')`,其中'a'代表的就是寄存器"a"。而"hello register a"就是你想存储的内容。

还有一种清除寄存器的方法就是使用表达式`:let @a = ''`来将寄存器"a 的值设为空的字符串。

## 获取寄存器中的内容

你可以使用`:put`命令来粘贴任何寄存器的内容。比如，如果你运行命令`:put a`,Vim就会打印出寄存器"a"的内容，这和`"ap`非常像，唯一的区别在于在普通模式下命令`p`在当前光标位置之后打印寄存器的内容，而`:put`新起一行来打印寄存器的内容。

因为`:put`是一个命令行命令，您可以传一个地址给它。`:10put a`将会在当前光标下数10行，然后插入新行，内容为寄存器a中的内容。

一个很酷的技巧是将黑洞寄存器(`"_`)传给`:put`命令。因为黑洞寄存器不保存任何值，`:put _`命令将插入一个新的空白行。您可将这个与全局命令联合起来，插入多个空行。比如，要在所有以文本"end"结尾的行下插入空行，使用`:g/end/put _`。在后面您将了解关于全局命令的知识。

## 聪明地学习寄存器

恭喜你成功地坚持到了最后！这一章有非常多的内容需要消化。如果你感觉被新的知识淹没，你要知道你并不孤单，当我最初开始学习Vim寄存器时也有这种感觉。

我并不认为你必须现在就记得所有的知识点。为了提高我们的生产效率，你可以从使用以下三类寄存器开始：
1. 匿名寄存器(`""`).
2. 命名寄存器 (`"a-z`).
3. 编号寄存器 (`"0-9`).

既然匿名寄存器是默认和`p`或`P`，你只需要学习两个寄存器：命名寄存器和编号寄存器。之后如果你需要用到其他的寄存器时你再逐渐地学习其他寄存器的用法，不用急，慢慢来。

普通人的短期记忆都是有极限的，大概每次只能记住5-7个信息。这就是为什么在我的日常编辑中，我只用3到7个命名寄存器的原因，我没有办法记住整整26个寄存器的内容。我通常从寄存器"a"开始用，之后用寄存器"b",以字母表升序的顺序来使用。尝试一下各种方法，看看哪种最适合你。

Vim寄存器非常强大，合理使用的话能够避免你输入数不清的重复文本。但是现在，是时候学习一下宏命令了。

## 链接

- [目录](./directory.md)
- 上一节: [Ch 7 - 点命令](./ch07_the_dot_command.md)
- 下一节: [Ch 9 - 宏](./ch09_macros.md)